from backend.app import app, db
from backend.models.tenants import Tenant
from backend.models.admin import User
from backend.models.equipment import Equipment
from backend.models.bookings import Booking
from backend.models.delivery import Delivery
from backend.models.maintenance import MaintenanceLog
from backend.models.invoice import Invoice
from datetime import date, timedelta
import random

def seed():
    with app.app_context():
        db.drop_all()
        db.create_all()

        # --- TENANTS ---
        tenants = [
            Tenant(name="Sydney Mobility", abn="12345678901", subdomain="sydney"),
            Tenant(name="Melbourne Mobility", abn="23456789012", subdomain="melbourne")
        ]
        db.session.add_all(tenants)
        db.session.commit()

        # --- USERS ---
        users = [
            User(email="admin@sydney.com", password="password", role="admin", tenant_id=tenants[0].id),
            User(email="staff@sydney.com", password="password", role="staff", tenant_id=tenants[0].id),
            User(email="driver@sydney.com", password="password", role="driver", tenant_id=tenants[0].id)
        ]
        db.session.add_all(users)
        db.session.commit()

        # --- EQUIPMENT ---
        equipment_list = [
            Equipment(name="Wheelchair Standard", quantity=10, location="Sydney CBD", tenant_id=tenants[0].id),
            Equipment(name="Wheelchair Electric", quantity=5, location="Sydney North", tenant_id=tenants[0].id),
            Equipment(name="Walker", quantity=15, location="Sydney West", tenant_id=tenants[0].id),
            Equipment(name="Crutches", quantity=20, location="Sydney South", tenant_id=tenants[0].id)
        ]
        db.session.add_all(equipment_list)
        db.session.commit()

        # --- BOOKINGS ---
        bookings = []
        for i in range(5):
            eq = random.choice(equipment_list)
            start = date.today() + timedelta(days=i)
            end = start + timedelta(days=7)
            booking = Booking(
                participant_name=f"Participant {i+1}",
                ndis_number=f"NDIS{i+1000}",
                equipment_id=eq.id,
                start_date=start,
                end_date=end,
                delivery_postcode=2000 + i,
                delivery_fee=15.0 + i*5,
                total_price=100.0 + i*20,
                status="pending",
                tenant_id=tenants[0].id
            )
            bookings.append(booking)
        db.session.add_all(bookings)
        db.session.commit()

        # --- DELIVERIES ---
        deliveries = []
        for b in bookings:
            delivery = Delivery(
                booking_id=b.id,
                driver_name="Driver 1",
                scheduled_time=date.today(),
                status="assigned"
            )
            deliveries.append(delivery)
        db.session.add_all(deliveries)
        db.session.commit()

        # --- MAINTENANCE LOGS ---
        maintenance_logs = [
            MaintenanceLog(
                equipment_id=equipment_list[0].id,
                description="Checked brakes and tires",
                performed_by="Technician A",
                date=date.today(),
                next_due=date.today() + timedelta(days=90)
            ),
            MaintenanceLog(
                equipment_id=equipment_list[1].id,
                description="Battery check",
                performed_by="Technician B",
                date=date.today(),
                next_due=date.today() + timedelta(days=60)
            )
        ]
        db.session.add_all(maintenance_logs)
        db.session.commit()

        # --- INVOICES ---
        invoices = []
        for b in bookings:
            invoice = Invoice(
                booking_id=b.id,
                invoice_number=f"INV-{b.id+1000}",
                issued_date=date.today(),
                total_amount=b.total_price,
                paid=False
            )
            invoices.append(invoice)
        db.session.add_all(invoices)
        db.session.commit()

        print("âœ… Demo data seeded successfully!")

if __name__ == "__main__":
    seed()
